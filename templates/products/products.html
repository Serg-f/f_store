{% extends 'products/base.html' %}
{% load static %}

<!-- Custom styles for this template -->
{% block css %}
    <link href="{% static '/vendor/css/products.css' %}" rel="stylesheet">
{% endblock %}

<!-- Page Content -->
{% block content %}
    <div class="container">


        <div class="row">

            <div class="col-lg-3">

                <h1 class="my-4">F-Store</h1>
                <div class="list-group">
                    {% for cat in cats %}
                        <a href="{% url 'products:category' cat.id %}" class="list-group-item">{{ cat }}</a>
                    {% endfor %}
                </div>

            </div>
            <!-- /.col-lg-3 -->

            <div class="col-lg-9">

                <div id="carouselExampleIndicators" class="carousel slide my-4" data-ride="carousel">
                    <ol class="carousel-indicators">
                        <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
                        <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
                        <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>
                    </ol>
                    <div class="carousel-inner" role="listbox">
                        <div class="carousel-item active">
                            <img class="d-block img-fluid" src="{% static '/vendor/img/slides/slide-1.jpg' %}"
                                 alt="First slide">
                        </div>
                        <div class="carousel-item">
                            <img class="d-block img-fluid" src="{% static '/vendor/img/slides/slide-2.jpg' %}"
                                 alt="Second slide">
                        </div>
                        <div class="carousel-item">
                            <img class="d-block img-fluid" src="{% static '/vendor/img/slides/slide-3.jpg' %}"
                                 alt="Third slide">
                        </div>
                    </div>
                    <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>

                <div class="row">
                    {% for prod in product_list %}

                        <div class="col-lg-4 col-md-6 mb-4" data-product-id="{{ prod.id }}">
                            <div class="card h-100">
                                <a href="#">
                                    <img prod-img-id="{{ prod.id }}" class="card-img-top"
                                         src="{{ prod.image.url }}"
                                         alt="{{ prod.name }}">
                                </a>
                                <div class="card-body">
                                    <h4 class="card-title">
                                        <a prod-name-id="{{ prod.id }}" href="#">{{ prod.name }}</a>
                                    </h4>
                                    <span prod-price-id="{{ prod.id }}" hidden>{{ prod.price }}</span>
                                    <h5>{{ prod.price|floatformat:"-2" }} €</h5>
                                    <p class="card-text">{{ prod.description }}</p>
                                </div>
                                <div class="card-footer text-center">
                                    <button onclick="createCartItem({{ prod.id }})" type="button"
                                            class="btn btn-outline-success">Add to cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="no_goods">No goods in this category</div>
                    {% endfor %}

                </div>

                {% if page_obj.has_other_pages %}
                    <nav aria-label="Page navigation example">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#">Previous</a>
                                </li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                                <li class="page-item{% if num == page_obj.number %} disabled pag{% endif %}">
                                    <a class="page-link"
                                       href="?page={{ num }}">{{ num }}</a>
                                </li>
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#">Next</a>
                                </li>
                            {% endif %}

                        </ul>
                    </nav>

                {% endif %}

            </div>

        </div>

    </div>
    <script>
        function updateCartByProdId(productId) {
            $.ajax({
                url: "{% url 'products:add_cart_item' %}",
                type: "POST",
                data: {
                    'product_id': productId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                dataType: 'json',
                success: function (data) {
                    cartItemId = data.cartItemId;
                    // Existing cart item input field
                    let existingCartItemInput = document.querySelector(`[data-cart-item-id='${cartItemId}']`);

                    // Case 1: Cart item already exists
                    if (existingCartItemInput) {
                        let currentQuantity = parseInt(existingCartItemInput.value);
                        existingCartItemInput.value = currentQuantity + 1;
                        updateFrontCart(cartItemId, 'update');
                    }
                    // Case 2: Cart item does not exist
                    else {
                        // Retrieve product data
                        let productDiv = document.querySelector(`[data-product-id='${productId}']`);
                        let productName = productDiv.querySelector(`[prod-name-id='${productId}']`).textContent;
                        let productImage = productDiv.querySelector(`[prod-img-id='${productId}']`).src;
                        let productPrice = parseFloat(productDiv.querySelector(`[prod-price-id='${productId}']`).textContent);

                        // Create new cart item HTML
                        let newCartItem = document.createElement('div');
                        newCartItem.className = 'cart-item';
                        newCartItem.id = `cart-item-${cartItemId}`;
                        newCartItem.innerHTML = `
                            <img src="${productImage}" alt="${productName}" class="cart-item-image">
                            <div class="cart-item-details">
                                <span class="cart-item-name">${productName}</span>
                                <div class="cart-item-controls">
                                    <button class="btn btn-outline-secondary" onclick="decrementQuantity(${cartItemId})">-</button>
                                    <input data-cart-item-id='${cartItemId}' type="text" class="form-control" value="1" readonly>
                                    <button class="btn btn-outline-secondary" onclick="incrementQuantity(${cartItemId})">+</button>
                                    <input price-id="${cartItemId}" value="${productPrice}" type="hidden">
                                    <span cart-cost-id='${cartItemId}' class="cart-item-cost">${productPrice.toFixed(2)} €</span>
                                    <a href="#" onclick="removeCartItem(${cartItemId})"><i class="fas fa-trash"></i></a>
                                </div>
                            </div>
                        `;

                        // Check if cartItemsDiv and totalCostDiv exist, create them if they don't
                        let cartItemsDiv = document.querySelector('.cart-items');
                        let totalCostDiv = document.getElementById('total-cost'); // Get the total cost div

                        cartItemsDiv.insertBefore(newCartItem, totalCostDiv);
                        document.getElementById('cart-content').style.display = 'block';
                        document.getElementById('empty-cart-message').style.display = 'none';

                        // Update front-end cart
                        updateFrontCart(cartItemId, 'update');
                    }
                }


            });
        }

        function createCartItem(productId) {
            updateCartByProdId(productId);
            console.log('Backend updated')
            // Add animation class to the product card
            let productCard = document.querySelector(`[data-product-id="${productId}"]`);
            if (productCard) {
                console.log('Start doing animation')
                productCard.classList.add('product-added');
                // Remove the animation class after 0.5s to reset the animation
                setTimeout(() => {
                    productCard.classList.remove('product-added');
                }, 500);
            }
        }


    </script>
{% endblock %}

<!-- Footer -->
{% block footer %}
    <footer class="py-5 bg-dark">

        <div class="container">
            <p class="m-0 text-center text-white">Copyright &copy; Store 2022</p>
        </div>
        <!-- /.container -->
    </footer>
{% endblock %}

